generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// TENANT (White-Label Products)
// ============================================================================

model Tenant {
  id                    String        @id @default(uuid()) @db.Uuid
  slug                  String        @unique  // Ex: "alignpro", "mbc"
  name                  String        // Ex: "AlignPro", "My Beauty Calendar"
  short_name            String?       // Ex: "AlignPro", "MBC"
  tagline               String?       // Slogan do produto
  description           String?       // Descrição do produto
  is_active             Boolean       @default(true)
  
  // Domínios associados (ex: ["dashboard-alignpro.com.br", "alignpro.com"])
  domains               String[]      @default([])
  
  // Cores do tema (valores HSL: "hue saturation% lightness%")
  theme_primary         String        // Cor primária principal
  theme_secondary       String?       // Cor secundária
  theme_accent          String?       // Cor de destaque
  theme_background      String?       // Cor de fundo
  theme_foreground      String?       // Cor do texto principal
  theme_card            String?       // Cor dos cards
  theme_border          String?       // Cor das bordas
  theme_muted           String?       // Cor de elementos secundários
  theme_sidebar         String?       // Cor da sidebar
  
  // Contato/Suporte
  support_email         String?
  support_phone         String?
  website_url           String?
  
  // Metadados
  logo_url              String?
  favicon_url           String?
  
  created_at            DateTime      @default(now())
  updated_at            DateTime      @default(now())
  
  // Relacionamentos
  companies             Company[]
  preonboardings        PreOnboarding[]

  @@map("app_fd14ee28a1_tenants")
}

enum BookingStatus {
  pending
  confirmed
  in_progress
  completed
  cancelled
  no_show
}

enum CompanySize {
  MEI
  SMALL
  MID
}

enum UserRole {
  admin
  attendant
  customer
}

enum PlanType {
  sessions
  recurring
}

enum RecurrenceType {
  daily
  weekly
  biweekly
  monthly
}

enum SubscriptionStatus {
  active
  completed
  expired
  cancelled
}

enum PaymentStatus {
  pending
  paid
  refunded
}

enum SessionStatus {
  scheduled
  completed
  cancelled
}

enum PreOnboardingStatus {
  pending
  completed
}

model Company {
  id                    String        @id @default(uuid()) @db.Uuid
  user_id               String        @unique @db.Uuid
  tenant_id             String?       @db.Uuid  // Relacionamento com Tenant (white-label)
  name                  String
  email                 String
  phone                 String
  business_type         String?
  is_active             Boolean       @default(true)
  services              String[]      @default([])
  background_image_url  String?
  banner_image_url      String?
  company_token         String?       @unique
  company_nickname      String?
  company_size          CompanySize?
  business_model        String?
  max_attendants        Int?          @default(1)
  features              Json?
  primary_phone         String?
  first_login_completed Boolean       @default(false)
  created_at            DateTime      @default(now())
  updated_at            DateTime      @default(now())
  
  // Cores personalizadas da empresa (valores HSL: "hue saturation% lightness%")
  theme_primary         String?       // Cor primária (ex: "346 73% 80%" - rosa padrão)
  theme_secondary       String?       // Cor secundária (ex: "346 43% 73%")
  theme_accent          String?       // Cor de destaque
  theme_background      String?       // Cor de fundo
  theme_foreground      String?       // Cor do texto principal
  theme_card            String?       // Cor dos cards
  theme_border          String?       // Cor das bordas
  theme_muted           String?       // Cor de elementos secundários
  theme_sidebar         String?       // Cor da sidebar

  tenant                Tenant?       @relation(fields: [tenant_id], references: [id], onDelete: SetNull)
  user                  User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  attendants            Attendant[]
  bookings              Booking[]
  services_rel          Service[]
  clients               Client[]
  plans                 Plan[]
  client_subscriptions  ClientSubscription[]
  business_hours        CompanyBusinessHours[]
  user_profiles         UserProfile[]
  plan_overrides        PlanOverride?
  subscription_sessions SubscriptionSession[]

  @@map("app_fd14ee28a1_companies")
}

model Attendant {
  id          String        @id @default(uuid()) @db.Uuid
  company_id  String        @db.Uuid
  name        String
  email       String?
  phone       String?
  is_active   Boolean       @default(true)
  created_at  DateTime      @default(now())
  updated_at  DateTime      @default(now())
  username    String
  user_id     String?       @db.Uuid

  company     Company       @relation(fields: [company_id], references: [id], onDelete: Cascade)
  user        User?         @relation(fields: [user_id], references: [id], onDelete: SetNull)
  bookings    Booking[]
  weekdays    AttendantWeekday[]
  links       AttendantLink[]
  banners     AttendantBanner[]
  sessions    SubscriptionSession[]

  @@unique([company_id, username])
  @@map("app_fd14ee28a1_attendants")
}

model Booking {
  id              String              @id @default(uuid()) @db.Uuid
  company_id      String              @db.Uuid
  attendant_id    String?             @db.Uuid
  client_name     String
  client_phone    String
  client_email    String
  service         String
  booking_date    DateTime            @db.Date
  booking_time    String
  date_time       DateTime?
  status          BookingStatus       @default(pending)
  notes           String?
  created_at      DateTime            @default(now())
  updated_at      DateTime            @default(now())
  service_id      String?             @db.Uuid
  client_id       String?             @db.Uuid
  subscription_id String?             @db.Uuid
  archived        Boolean             @default(false)

  company         Company             @relation(fields: [company_id], references: [id], onDelete: Cascade)
  attendant       Attendant?          @relation(fields: [attendant_id], references: [id], onDelete: SetNull)
  service_rel     Service?            @relation(fields: [service_id], references: [id], onDelete: SetNull)
  client          Client?             @relation(fields: [client_id], references: [id], onDelete: SetNull)
  subscription    ClientSubscription? @relation(fields: [subscription_id], references: [id], onDelete: SetNull)
  sessions        SubscriptionSession[]
  bookingServices BookingService[]

  @@map("app_fd14ee28a1_bookings")
}

model BookingService {
  id          String   @id @default(uuid()) @db.Uuid
  booking_id  String   @db.Uuid
  service_id  String   @db.Uuid
  created_at  DateTime @default(now())

  booking     Booking  @relation(fields: [booking_id], references: [id], onDelete: Cascade)
  service     Service  @relation(fields: [service_id], references: [id], onDelete: Cascade)

  @@unique([booking_id, service_id])
  @@map("app_fd14ee28a1_booking_services")
}

model Service {
  id               String        @id @default(uuid()) @db.Uuid
  company_id       String        @db.Uuid
  name             String
  description      String?
  duration_minutes Int           @default(30)
  price            Decimal?      @db.Decimal(10, 2)
  is_active        Boolean       @default(true)
  created_at       DateTime      @default(now())
  updated_at       DateTime      @default(now())

  company          Company       @relation(fields: [company_id], references: [id], onDelete: Cascade)
  bookings         Booking[]
  plans            Plan[]
  bookingServices BookingService[]

  @@map("app_fd14ee28a1_services")
}

model CompanyBusinessHours {
  id         String   @id @default(uuid()) @db.Uuid
  company_id String   @db.Uuid
  weekday    Int
  is_open    Boolean  @default(true)
  open_time  String?
  close_time String?
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  company    Company  @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@unique([company_id, weekday])
  @@map("app_fd14ee28a1_company_business_hours")
}

model AttendantWeekday {
  id           String   @id @default(uuid()) @db.Uuid
  attendant_id String   @db.Uuid
  weekday      Int
  is_active    Boolean  @default(true)
  start_time   String?
  end_time     String?
  created_at   DateTime @default(now())
  updated_at   DateTime @default(now())

  attendant    Attendant @relation(fields: [attendant_id], references: [id], onDelete: Cascade)

  @@unique([attendant_id, weekday])
  @@map("app_fd14ee28a1_attendant_weekdays")
}

model AttendantLink {
  id            String   @id @default(uuid()) @db.Uuid
  attendant_id  String   @db.Uuid
  title         String
  url           String
  icon          String?
  is_active     Boolean  @default(true)
  display_order Int      @default(0)
  created_at    DateTime @default(now())
  updated_at    DateTime @default(now())

  attendant     Attendant @relation(fields: [attendant_id], references: [id], onDelete: Cascade)

  @@unique([attendant_id])
  @@map("app_fd14ee28a1_attendant_links")
}

model AttendantBanner {
  id           String   @id @default(uuid()) @db.Uuid
  attendant_id String   @db.Uuid
  image_url    String
  title        String?
  subtitle     String?
  is_active    Boolean  @default(true)
  created_at   DateTime @default(now())
  updated_at   DateTime @default(now())

  attendant    Attendant @relation(fields: [attendant_id], references: [id], onDelete: Cascade)

  @@unique([attendant_id])
  @@map("app_fd14ee28a1_attendant_banners")
}

model UserProfile {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid
  company_id String?  @db.Uuid
  role       UserRole @default(customer)
  full_name  String?
  avatar_url String?
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  company    Company? @relation(fields: [company_id], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, company_id])
  @@map("app_fd14ee28a1_user_profiles")
}

model Client {
  id         String   @id @default(uuid()) @db.Uuid
  company_id String   @db.Uuid
  name       String
  phone      String
  email      String?
  notes      String?
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  company    Company  @relation(fields: [company_id], references: [id], onDelete: Cascade)
  bookings   Booking[]
  subscriptions ClientSubscription[]

  @@unique([company_id, phone])
  @@map("app_fd14ee28a1_clients")
}

model Plan {
  id                  String         @id @default(uuid()) @db.Uuid
  company_id          String         @db.Uuid
  service_id          String?        @db.Uuid
  name                String
  description         String?
  plan_type           PlanType
  total_sessions      Int?
  recurrence_type     RecurrenceType?
  recurrence_interval Int?           @default(1)
  price               Decimal        @db.Decimal(10, 2)
  is_active           Boolean        @default(true)
  created_at          DateTime       @default(now())
  updated_at          DateTime       @default(now())

  company             Company        @relation(fields: [company_id], references: [id], onDelete: Cascade)
  service             Service?       @relation(fields: [service_id], references: [id], onDelete: SetNull)
  subscriptions       ClientSubscription[]

  @@map("app_fd14ee28a1_plans")
}

model ClientSubscription {
  id                  String              @id @default(uuid()) @db.Uuid
  client_id           String              @db.Uuid
  plan_id             String              @db.Uuid
  company_id          String              @db.Uuid
  sessions_remaining  Int?
  sessions_used       Int                 @default(0)
  next_booking_date   DateTime?           @db.Date
  last_booking_date   DateTime?           @db.Date
  status              SubscriptionStatus  @default(active)
  start_date          DateTime            @db.Date
  end_date            DateTime?           @db.Date
  amount_paid         Decimal?            @db.Decimal(10, 2)
  payment_status      PaymentStatus       @default(pending)
  notes               String?
  expired_at          DateTime?
  cancelled_at        DateTime?
  cancellation_reason String?
  created_at          DateTime            @default(now())
  updated_at          DateTime            @default(now())

  client              Client              @relation(fields: [client_id], references: [id], onDelete: Cascade)
  plan                Plan                @relation(fields: [plan_id], references: [id], onDelete: Restrict)
  company             Company             @relation(fields: [company_id], references: [id], onDelete: Cascade)
  bookings            Booking[]
  sessions            SubscriptionSession[]

  @@map("app_fd14ee28a1_client_subscriptions")
}

model SubscriptionSession {
  id             String            @id @default(uuid()) @db.Uuid
  subscription_id String           @db.Uuid
  booking_id     String?           @db.Uuid
  company_id     String            @db.Uuid
  session_number Int
  status         SessionStatus     @default(scheduled)
  scheduled_date DateTime?         @db.Date
  completed_at   DateTime?
  notes          String?
  created_at     DateTime          @default(now())
  updated_at     DateTime          @default(now())
  scheduled_time String?
  archived       Boolean           @default(false)
  attendant_id   String?           @db.Uuid

  subscription   ClientSubscription @relation(fields: [subscription_id], references: [id], onDelete: Cascade)
  booking        Booking?           @relation(fields: [booking_id], references: [id], onDelete: SetNull)
  company        Company            @relation(fields: [company_id], references: [id], onDelete: Cascade)
  attendant      Attendant?         @relation(fields: [attendant_id], references: [id], onDelete: SetNull)

  @@unique([subscription_id, session_number])
  @@map("app_fd14ee28a1_subscription_sessions")
}

model PreOnboarding {
  id                   String               @id @default(uuid()) @db.Uuid
  company_token        String               @unique
  company_nickname     String
  company_size         CompanySize
  business_model       String
  max_attendants       Int                  @default(1)
  primary_phone        String
  features             Json?
  is_used              Boolean              @default(false)
  used_at              DateTime?
  used_by_user_id      String?              @db.Uuid
  tenant_id            String?              @db.Uuid  // Relacionamento com Tenant (white-label)
  used_by_user         User?                @relation(fields: [used_by_user_id], references: [id], onDelete: SetNull)
  tenant               Tenant?              @relation(fields: [tenant_id], references: [id], onDelete: SetNull)
  notes                String?
  created_at           DateTime             @default(now())
  updated_at           DateTime             @default(now())
  features_de_interesse String?
  status               PreOnboardingStatus  @default(pending)
  completed_at         DateTime?

  @@map("app_fd14ee28a1_preonboarding")
}

model PlanOverride {
  id            String   @id @default(uuid()) @db.Uuid
  company_id    String   @unique @db.Uuid
  max_attendants Int?
  max_services  Int?
  max_links     Int?
  max_banners   Int?
  notes         String?
  created_at    DateTime @default(now())
  updated_at    DateTime @default(now())

  company       Company  @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@map("app_fd14ee28a1_plan_overrides")
}

model User {
  id             String     @id @default(uuid()) @db.Uuid
  email          String     @unique
  password_hash  String
  created_at     DateTime   @default(now())
  updated_at     DateTime   @default(now())

  companies      Company[]
  attendants     Attendant[]
  profiles       UserProfile[]
  sessions       Session[]
  preonboardings PreOnboarding[]

  @@map("app_fd14ee28a1_users")
}

model Session {
  id                  String   @id @default(uuid()) @db.Uuid
  user_id             String   @db.Uuid
  refresh_token_hash  String
  user_agent          String?
  ip_address          String?
  expires_at          DateTime
  revoked_at          DateTime?
  created_at          DateTime @default(now())
  updated_at          DateTime @default(now())

  user                User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("app_fd14ee28a1_auth_sessions")
}

model Lead {
  id                    String   @id @default(uuid()) @db.Uuid
  name                  String
  email                 String
  phone                 String
  business_type         String
  custom_business_type  String?
  attendants_count      Int?
  source_message        String?
  created_at            DateTime @default(now())
  updated_at            DateTime @default(now())

  @@map("app_fd14ee28a1_leads")
}
